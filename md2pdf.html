<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF V9 (é‚Šè·ä¿®æ­£ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'none' },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; background: #333; font-family: sans-serif; }
        
        header { 
            height: 50px; background: #222; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #444;
        }
        
        .main { display: flex; flex: 1; overflow: hidden; }
        
        /* ç·¨è¼¯å€ */
        .editor { width: 50%; border-right: 1px solid #444; display: flex; flex-direction: column; }
        textarea { 
            flex: 1; background: #1e1e1e; color: #ddd; border: none; padding: 20px; resize: none; outline: none; font-family: monospace; line-height: 1.6; font-size: 14px;
        }

        /* é è¦½å€ */
        .preview { 
            width: 50%; background: #525659; overflow-y: auto; display: flex; justify-content: center; padding: 30px; 
        }

        /* A4 ç´™å¼µ */
        #paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            /* é è¦½æ™‚æˆ‘å€‘ä¿ç•™ padding è®“ä½ çœ‹èµ·ä¾†åƒç´™å¼µ */
            padding: 20mm; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            color: #333;
        }

        /* å…§å®¹æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 2px solid #333; }
        th, td { border: 1px solid #999; padding: 6px; }
        img { max-width: 100%; }
        
        /* é˜²åˆ‡æ–· */
        p, h1, h2, h3, li, table, pre, .math-container { 
            page-break-inside: avoid; break-inside: avoid; 
        }
        .math-container { text-align: center; margin: 1em 0; }
        
        /* Loading */
        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:999;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 20px; margin-bottom: 10px;">æ­£åœ¨ç”Ÿæˆ PDF...</div>
        <div style="font-size: 14px; color: #aaa;">æ­£åœ¨æ ¡æº–é‚Šè·èˆ‡æ¸²æŸ“å…¬å¼</div>
    </div>

    <header>
        <div>MD2PDF V9 (é˜²åˆ‡é‚Šç‰ˆ)</div>
        <button onclick="downloadPDF()" style="cursor:pointer; background:#2980b9; color:white; border:none; padding:6px 15px; border-radius:4px;">ä¸‹è¼‰ PDF</button>
    </header>

    <div class="main">
        <div class="editor">
            <textarea id="input"># é‚Šè·æ¸¬è©¦å ±å‘Š

è«‹æª¢æŸ¥å·¦å´æ–‡å­—æ˜¯å¦å®Œæ•´ï¼Œä¸æ‡‰è¢«åˆ‡æ–·ã€‚

## 1. é‚Šç·£æ¸¬è©¦
This is a test sentence to check the left margin.
é€™æ˜¯ä¸€æ®µæ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†æª¢æŸ¥å·¦é‚Šè·æ˜¯å¦æ­£å¸¸ã€‚

## 2. è¡¨æ ¼æ¸¬è©¦ (å…¨å¯¬)
| æ¸¬è©¦é …ç›® | çµæœ | å‚™è¨» |
|:---|:---|:---|
| å·¦é‚Šè· | âœ… Pass | æ–‡å­—æœªè¢«åˆ‡æ–· |
| ä¸Šé‚Šè· | âœ… Pass | é çœ‰æ­£å¸¸ |
| æ•¸å­¸å…¬å¼ | âœ… Pass | åœ–ç‰‡åŒ–æ¸²æŸ“ |

## 3. æ•¸å­¸å…¬å¼
$$
E = \frac{mc^2}{\sqrt{1-\frac{v^2}{c^2}}}
$$
            </textarea>
        </div>
        <div class="preview">
            <div id="paper"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const paper = document.getElementById('paper');
        const loading = document.getElementById('loading');

        // --- 1. æ¸²æŸ“ (Markdown + LaTeXä½”ä½) ---
        function render() {
            let md = input.value;
            let mathStore = [];
            
            // ä¿è­· LaTeX
            md = md.replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => {
                mathStore.push({t, type:'block'}); return `___MB${mathStore.length-1}___`;
            });
            md = md.replace(/\$([^\$\n]+?)\$/g, (m, t) => {
                mathStore.push({t, type:'inline'}); return `___MI${mathStore.length-1}___`;
            });

            let html = marked.parse(md);

            // é‚„åŸ LaTeX
            html = html.replace(/___MB(\d+)___/g, (m, i) => `<div class="math-container">$$${mathStore[i].t}$$</div>`);
            html = html.replace(/___MI(\d+)___/g, (m, i) => `$${mathStore[i].t}$`);

            paper.innerHTML = html;

            if(window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([paper]);
            }
        }

        let timer;
        input.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(render, 300); });
        setTimeout(render, 500);

        // --- 2. è½‰åœ–ç‰‡ (é˜²å…¬å¼è·‘ç‰ˆ) ---
        async function rasterize() {
            const svgs = paper.querySelectorAll('mjx-container svg');
            for(let svg of svgs) {
                try {
                    const rect = svg.getBoundingClientRect();
                    if(rect.width<1) continue;
                    
                    const xml = new XMLSerializer().serializeToString(svg);
                    const svg64 = btoa(unescape(encodeURIComponent(xml)));
                    
                    const img = new Image();
                    img.src = 'data:image/svg+xml;base64,' + svg64;
                    await new Promise(r => img.onload = r);

                    const canvas = document.createElement('canvas');
                    // æ”¾å¤§3å€ä¿æŒæ¸…æ™°
                    canvas.width = rect.width * 3;
                    canvas.height = rect.height * 3;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(3, 3);
                    ctx.drawImage(img, 0, 0);

                    const finalImg = document.createElement('img');
                    finalImg.src = canvas.toDataURL('image/png');
                    finalImg.style.width = rect.width + 'px';
                    
                    const container = svg.closest('mjx-container');
                    if(container) container.replaceWith(finalImg);
                } catch(e) { console.error(e); }
            }
        }

        // --- 3. ä¸‹è¼‰ PDF (ä¿®å¾©é‚Šè·çš„æ ¸å¿ƒ) ---
        async function downloadPDF() {
            loading.style.display = 'flex';
            
            // A. ä¿å­˜ç‹€æ…‹
            const originalContent = paper.innerHTML;
            const originalStyle = paper.getAttribute('style'); // ä¿å­˜åŸæœ¬çš„ padding
            
            // B. åœ–ç‰‡åŒ–å…¬å¼
            await rasterize();

            // C. ğŸ”¥ é—œéµä¿®æ”¹ï¼šç”Ÿæˆæ™‚ç§»é™¤ CSS paddingï¼Œæ”¹ç”¨ PDF margin ğŸ”¥
            // é€™æ¨£ html2canvas å°±æœƒå¾ (0,0) é–‹å§‹æˆªåœ–ï¼Œçµ•å°ä¸æœƒåˆ‡å·¦é‚Š
            paper.style.padding = '0'; 
            paper.style.boxShadow = 'none'; // ç§»é™¤é™°å½±é¿å…å¹²æ“¾è¨ˆç®—

            const opt = {
                // é€™è£¡è¨­å®š PDF çš„é‚Šè· (ä¸Š, å·¦, ä¸‹, å³)
                // è¨­ç‚º 20mmï¼Œç­‰åŒæ–¼åŸæœ¬çš„ CSS padding
                margin:       [20, 20, 20, 20], 
                filename:     'md2pdf_v9.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0, // å¼·åˆ¶æ­¸é›¶
                    scrollY: 0, // å¼·åˆ¶æ­¸é›¶
                    // ç¨å¾®èª¿å¤§ä¸€é»å¯¬åº¦å®¹éŒ¯
                    windowWidth: 1000 
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                await html2pdf().set(opt).from(paper).save();
            } catch(e) {
                alert('éŒ¯èª¤: ' + e.message);
            } finally {
                // D. é‚„åŸ
                paper.innerHTML = originalContent;
                if(originalStyle) paper.setAttribute('style', originalStyle);
                else paper.style.padding = '20mm'; // é è¨­å€¼
                
                // é‡æ–°æ¸²æŸ“ MathJax
                if(window.MathJax && window.MathJax.typesetPromise) window.MathJax.typesetPromise([paper]);
                
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
