<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF - åˆ†æ•¸ä¿®å¾©ç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            svg: { 
                fontCache: 'none', /* é—œéµï¼šç¦ç”¨å…¨å±€ç·©å­˜ï¼Œç¢ºä¿æ¯å€‹ SVG ç¨ç«‹å®Œæ•´ */
                scale: 1 
            },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; background: #525659; }
        header { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .container { display: flex; flex: 1; overflow: hidden; }
        .pane { width: 50%; display: flex; flex-direction: column; }
        
        textarea { 
            flex: 1; padding: 20px; border: none; resize: none; outline: none; 
            font-family: 'Consolas', monospace; font-size: 15px; line-height: 1.6;
        }

        #preview-pane { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        
        #content {
            background: white;
            width: 210mm; min-height: 297mm; padding: 20mm;
            box-sizing: border-box; color: #333;
        }

        /* æ¨£å¼èˆ‡é˜²åˆ‡æ–· */
        p, h1, h2, li, table, img, .math-protect { 
            page-break-inside: avoid; break-inside: avoid; 
        }
        
        /* è®“åœ–ç‰‡åŒ–çš„å…¬å¼èˆ‡æ–‡å­—å°é½Š */
        img.math-img-inline { vertical-align: middle; display: inline-block; }
        img.math-img-block { display: block; margin: 1em auto; max-width: 100%; }

        table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #ccc; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; }
        
        /* Loading é®ç½© */
        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
            color:white; display:none; justify-content:center; align-items:center; z-index:999;
        }
    </script>
</head>
<body>
    <div id="loading">æ­£åœ¨å°‡å…¬å¼è½‰æ›ç‚ºåœ–ç‰‡ä»¥é˜²æ­¢è·‘ç‰ˆ...</div>

    <header>
        <div style="font-weight: bold;">MD2PDF (åˆ†æ•¸ä¿®å¾©ç‰ˆ)</div>
        <button onclick="generatePDF()" style="padding:8px 15px; cursor:pointer; background:#4CAF50; color:white; border:none; border-radius:4px;">ä¸‹è¼‰ PDF</button>
    </header>

    <div class="container">
        <div class="pane">
            <textarea id="editor" placeholder="è¼¸å…¥ Markdown..."># åˆ†æ•¸æ¸¬è©¦

é€™è£¡æ¸¬è©¦è¤‡é›œçš„åˆ†æ•¸æ˜¯å¦æœƒè·‘ç‰ˆã€‚

## 1. ç°¡å–®åˆ†æ•¸
è¡Œå…§æ¸¬è©¦ï¼š $a = \frac{1}{2} + \frac{x}{y}$ æ‡‰è©²è¦é¡¯ç¤ºæ­£å¸¸ã€‚

## 2. è¤‡é›œåˆ†æ•¸ (å·¢ç‹€)
$$
f(x) = \frac{x^2 + 1}{\sqrt{\frac{a}{b}} + \frac{c}{d}}
$$

## 3. ç©åˆ†èˆ‡æ¥µé™
$$
\int_{0}^{\infty} \frac{\sin x}{x} dx = \frac{\pi}{2}
$$

## 4. çŸ©é™£
$$
\begin{pmatrix} \frac{1}{2} & 0 \\ 0 & \frac{3}{4} \end{pmatrix}
$$
            </textarea>
        </div>
        <div class="pane" id="preview-pane">
            <div id="content"></div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const content = document.getElementById('content');
        let mathCache = {};

        // 1. åŸºæœ¬æ¸²æŸ“é‚è¼¯
        function escapeMath(text) {
            mathCache = {}; let i = 0;
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => { mathCache[`MB_${i}`] = {t, d:true}; return `MB_${i++}`; });
            text = text.replace(/\$([^\$\n]+?)\$/g, (m, t) => { mathCache[`MI_${i}`] = {t, d:false}; return `MI_${i++}`; });
            return text;
        }

        function restoreMath(html) {
            for (let k in mathCache) {
                // ç‚ºå€å¡Šå…¬å¼åŠ ä¸Šä¿è­·æ®¼
                let tag = mathCache[k].d 
                    ? `<div class="math-protect">$$${mathCache[k].t}$$</div>` 
                    : `$${mathCache[k].t}$`;
                html = html.replace(k, tag);
            }
            return html;
        }

        function render() {
            let md = editor.value;
            md = escapeMath(md);
            let html = marked.parse(md);
            html = restoreMath(html);
            content.innerHTML = html;
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([content]);
            }
        }

        editor.addEventListener('input', () => setTimeout(render, 500));
        setTimeout(render, 500);


        // --- ğŸ”¥ æ ¸å¿ƒä¿®å¾©ï¼šSVG è½‰ åœ–ç‰‡ å‡½æ•¸ ğŸ”¥ ---
        async function convertSvgToImage(element) {
            const svgs = element.querySelectorAll('mjx-container svg');
            
            for (let svg of svgs) {
                // 1. å–å¾— SVG å…§å®¹èˆ‡å°ºå¯¸
                const xml = new XMLSerializer().serializeToString(svg);
                const rect = svg.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                // 2. å»ºç«‹ Canvas (æ”¾å¤§ 3 å€ä»¥ä¿æŒæ¸…æ™°åº¦)
                const scale = 3; 
                const canvas = document.createElement('canvas');
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);

                // 3. å»ºç«‹åœ–ç‰‡ç‰©ä»¶è¼‰å…¥ SVG
                const img = new Image();
                // å¿…é ˆæŠŠ SVG è½‰ç‚º Base64 æ‰èƒ½ç•«åˆ° Canvas ä¸Š
                const svg64 = btoa(unescape(encodeURIComponent(xml)));
                const b64Start = 'data:image/svg+xml;base64,';
                const imageSrc = b64Start + svg64;

                await new Promise((resolve) => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve();
                    };
                    img.src = imageSrc;
                });

                // 4. ç”¨ç”Ÿæˆçš„ PNG åœ–ç‰‡æ›¿æ›æ‰åŸæœ¬çš„ MathJax å®¹å™¨
                const pngUrl = canvas.toDataURL('image/png');
                const finalImg = document.createElement('img');
                finalImg.src = pngUrl;
                // è¨­å®šåœ–ç‰‡é¡¯ç¤ºå°ºå¯¸ç­‰æ–¼åŸæœ¬ SVG å°ºå¯¸
                finalImg.style.width = `${width}px`;
                finalImg.style.height = `${height}px`;
                
                // å€åˆ†è¡Œå…§æˆ–å€å¡Šæ¨£å¼
                const container = svg.closest('mjx-container');
                if (container.getAttribute('display') === 'true') {
                    finalImg.className = 'math-img-block';
                } else {
                    finalImg.className = 'math-img-inline';
                }

                // æ›¿æ› DOM
                container.parentNode.replaceChild(finalImg, container);
            }
        }

        // --- ç”Ÿæˆ PDF ä¸»æµç¨‹ ---
        async function generatePDF() {
            // é¡¯ç¤º Loading
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            // 1. è¤‡è£½ä¸€ä»½ content ä¾†è™•ç†ï¼Œé¿å…ç ´å£ç·¨è¼¯ç•«é¢
            const originalContent = document.getElementById('content');
            const clone = originalContent.cloneNode(true);
            
            // æ”¾åˆ°ä¸€å€‹çœ‹ä¸åˆ°çš„åœ°æ–¹
            clone.style.position = 'absolute';
            clone.style.top = '-10000px';
            clone.style.width = '210mm'; // ç¢ºä¿å¯¬åº¦ä¸€è‡´
            clone.style.padding = '20mm';
            clone.style.background = 'white';
            document.body.appendChild(clone);

            // 2. ç­‰å¾…ä¸€ä¸‹ç¢ºä¿è¤‡è£½çš„ DOM å·²æ¸²æŸ“
            await new Promise(r => setTimeout(r, 100));

            try {
                // 3. ğŸ”¥ æŠŠè¤‡è£½å‡ºä¾†çš„ DOM è£¡çš„ SVG å…¨éƒ¨è½‰æˆ PNG ğŸ”¥
                await convertSvgToImage(clone);

                // 4. åŸ·è¡Œ html2pdf
                const opt = {
                    margin: 0,
                    filename: 'math-fixed.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                await html2pdf().set(opt).from(clone).save();

            } catch (e) {
                console.error(e);
                alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ console');
            } finally {
                // 5. æ¸…ç†æˆ°å ´
                document.body.removeChild(clone);
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
