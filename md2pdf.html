<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF Ultimate</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            svg: {
                fontCache: 'none' // é—œéµï¼šç¦ç”¨ç·©å­˜ï¼Œç¢ºä¿æ¯å€‹å…¬å¼éƒ½æ˜¯ç¨ç«‹å®Œæ•´çš„ SVG
            },
            startup: {
                typeset: false // æ‰‹å‹•æ§åˆ¶æ¸²æŸ“æ™‚æ©Ÿ
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        /* --- ç³»çµ±é‡ç½® --- */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #2b2b2b; }

        /* --- é ‚éƒ¨å·¥å…·åˆ— --- */
        header {
            height: 60px; background: #1e1e1e; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #333;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 500; letter-spacing: 1px; }
        
        button {
            background: #007acc; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 600; transition: background 0.2s;
        }
        button:hover { background: #0062a3; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* --- ä¸»å€åŸŸ --- */
        .main-layout { display: flex; flex: 1; overflow: hidden; }

        /* å·¦å´ç·¨è¼¯å™¨ */
        .editor-container { width: 50%; height: 100%; border-right: 1px solid #333; display: flex; flex-direction: column; }
        textarea {
            flex: 1; width: 100%; background: #1e1e1e; color: #d4d4d4; border: none; padding: 20px; resize: none; outline: none; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.6;
        }

        /* å³å´é è¦½å€ (æ¨¡æ“¬ PDF é–±è®€å™¨èƒŒæ™¯) */
        .preview-container {
            width: 50%; height: 100%; background: #525659; overflow-y: auto; display: flex; justify-content: center; padding: 30px;
        }

        /* A4 ç´™å¼µæœ¬é«” */
        #paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: #24292e;
            font-size: 16px;
            line-height: 1.6;
        }

        /* --- å…§å®¹æ¨£å¼ (Markdown æ¸²æŸ“å¾Œ) --- */
        #paper h1, #paper h2, #paper h3 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; margin-top: 24px; margin-bottom: 16px; color: #24292e; }
        #paper p { margin-bottom: 16px; }
        #paper code { background-color: #f6f8fa; padding: 0.2em 0.4em; border-radius: 6px; font-family: monospace; font-size: 85%; }
        #paper pre { background-color: #f6f8fa; padding: 16px; overflow: auto; border-radius: 6px; line-height: 1.45; }
        #paper pre code { background: none; padding: 0; font-size: 100%; }
        #paper blockquote { padding: 0 1em; color: #6a737d; border-left: 0.25em solid #dfe2e5; margin: 0 0 16px 0; }
        #paper table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
        #paper th, #paper td { padding: 6px 13px; border: 1px solid #dfe2e5; }
        #paper tr:nth-child(2n) { background-color: #f6f8fa; }
        #paper img { max-width: 100%; box-sizing: content-box; background-color: #fff; }

        /* --- ğŸ”¥ æ ¸å¿ƒï¼šé˜²åˆ‡æ–·èˆ‡ LaTeX æ¨£å¼ ğŸ”¥ --- */
        
        /* 1. å¼·åˆ¶é€™äº›å…ƒç´ ä¸è¦åœ¨å…§éƒ¨æ›é  */
        p, h1, h2, h3, li, ul, ol, table, pre, blockquote, .math-block-container, img {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* 2. æ•¸å­¸å…¬å¼å®¹å™¨ */
        .math-block-container {
            display: block;
            margin: 1em 0;
            text-align: center;
            overflow-x: hidden; /* é˜²æ­¢å…¬å¼å¤ªé•·æ’ç ´ç‰ˆé¢ */
        }
        
        /* 3. åœ–ç‰‡åŒ–å¾Œçš„å…¬å¼æ¨£å¼ */
        img.math-img-block { display: block; margin: 0 auto; max-width: 100%; }
        img.math-img-inline { vertical-align: middle; }

        /* --- Loading é®ç½© --- */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007acc; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨è™•ç†æ•¸å­¸å…¬å¼èˆ‡æ’ç‰ˆ...</div>
    </div>

    <header>
        <h1>MD2PDF PRO</h1>
        <button id="btn-download" onclick="generatePDF()">ä¸‹è¼‰ PDF</button>
    </header>

    <div class="main-layout">
        <div class="editor-container">
            <textarea id="input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ Markdown èˆ‡ LaTeX..."># å®Œæ•´æ¸¬è©¦å ±å‘Š

## 1. ç°¡ä»‹
é€™æ˜¯ä¸€å€‹æ¸¬è©¦ Markdown è½‰ PDF çš„æ–‡ä»¶ï¼Œé‡é»åœ¨æ–¼æ¸¬è©¦ **LaTeX å…¬å¼** ä»¥åŠ **åˆ†é ä¸åˆ‡æ–·** çš„åŠŸèƒ½ã€‚

## 2. è¤‡é›œæ•¸å­¸å…¬å¼ (å€å¡Š)
é¦¬å…‹å£«å¨æ–¹ç¨‹çµ„ï¼š
$$
\begin{aligned}
\nabla \cdot \mathbf{E} &= \frac{\rho}{\varepsilon_0} \\
\nabla \cdot \mathbf{B} &= 0 \\
\nabla \times \mathbf{E} &= -\frac{\partial \mathbf{B}}{\partial t} \\
\nabla \times \mathbf{B} &= \mu_0\mathbf{J} + \mu_0\varepsilon_0\frac{\partial \mathbf{E}}{\partial t}
\end{aligned}
$$

## 3. åˆ†æ•¸èˆ‡æ ¹è™Ÿæ¸¬è©¦
ä¸€å®šè¦ç¢ºä¿åˆ†æ•¸ç·šæ¸…æ™°å¯è¦‹ï¼š
$$
f(x) = \sqrt{1+\frac{x^2}{2}} + \int_{-\infty}^{\infty} e^{-x^2} dx
$$

## 4. è¡¨æ ¼æ¸¬è©¦ (é˜²åˆ‡æ–·)
è¡¨æ ¼æ‡‰è©²å®Œæ•´é¡¯ç¤ºï¼Œæˆ–è€…æ•´å¡Šç§»åˆ°ä¸‹ä¸€é ã€‚

| åƒæ•¸ | æ•¸å€¼ | æè¿° |
|:---|:---|:---|
| Alpha | 0.001 | å­¸ç¿’ç‡ |
| Beta  | 0.9   | å‹•é‡åƒæ•¸ |
| Gamma | 1e-5  | æ­£å‰‡åŒ–é … |
| Delta | 3.14  | åœ“å‘¨ç‡è¿‘ä¼¼ |

## 5. è¡Œå…§å…¬å¼
é€™æ˜¯ä¸€æ®µæ–‡å­—ï¼Œå…¶ä¸­åŒ…å«è¡Œå…§å…¬å¼ $E = mc^2$ ä»¥åŠ $e^{i\pi} + 1 = 0$ï¼Œç¢ºä¿å®ƒå€‘èˆ‡æ–‡å­—å°é½Šã€‚
            </textarea>
        </div>
        <div class="preview-container">
            <div id="paper"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const paper = document.getElementById('paper');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');

        // --- 1. æ¸²æŸ“å¼•æ“ (Markdown + LaTeX ä¿è­·) ---
        function render() {
            const raw = input.value;
            let mathStorage = [];

            // A. ä¿è­· LaTeXï¼šä½¿ç”¨ç‰¹æ®Š Token æ›¿æ› $$...$$ å’Œ $...$
            // ä½¿ç”¨ UUID æˆ–è¤‡é›œå­—ä¸²é˜²æ­¢è¡çª
            let protectedText = raw.replace(/\$\$([\s\S]*?)\$\$/g, (match, tex) => {
                mathStorage.push({ type: 'block', tex: tex });
                return `___MATH_BLOCK_${mathStorage.length - 1}___`;
            });

            protectedText = protectedText.replace(/\$([^\$\n]+?)\$/g, (match, tex) => {
                mathStorage.push({ type: 'inline', tex: tex });
                return `___MATH_INLINE_${mathStorage.length - 1}___`;
            });

            // B. Marked è§£æ HTML
            let html = marked.parse(protectedText);

            // C. é‚„åŸ LaTeX ä¸¦åŠ ä¸Šå®¹å™¨
            html = html.replace(/___MATH_BLOCK_(\d+)___/g, (match, index) => {
                // å€å¡Šå…¬å¼ï¼šç”¨ div åŒ…è£¹ï¼Œä¸¦åŠ ä¸Šé˜²åˆ‡æ–· class
                return `<div class="math-block-container">$$${mathStorage[index].tex}$$</div>`;
            });

            html = html.replace(/___MATH_INLINE_(\d+)___/g, (match, index) => {
                // è¡Œå…§å…¬å¼
                return `$${mathStorage[index].tex}$`;
            });

            paper.innerHTML = html;

            // D. è§¸ç™¼ MathJax æ¸²æŸ“ (ç•°æ­¥)
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([paper]).catch(err => console.error(err));
            }
        }

        // ç›£è½è¼¸å…¥ (é˜²æŠ–å‹•)
        let debounceTimer;
        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(render, 300);
        });

        // åˆå§‹åŒ–
        setTimeout(render, 500);


        // --- 2. é—œéµæŠ€è¡“ï¼šSVG æŸµæ ¼åŒ– (SVG -> PNG) ---
        // é€™æ˜¯è§£æ±º PDF ç©ºç™½ã€è·‘ç‰ˆã€ç¼ºå­—çš„å”¯ä¸€æ­£è§£
        async function rasterizeMathJax() {
            const svgs = paper.querySelectorAll('mjx-container svg');
            loadingText.innerText = `æ­£åœ¨å„ªåŒ– ${svgs.length} å€‹æ•¸å­¸å…¬å¼...`;

            for (let svg of svgs) {
                try {
                    const rect = svg.getBoundingClientRect();
                    if (rect.width <= 0 || rect.height <= 0) continue;

                    // 1. åºåˆ—åŒ– SVG
                    const xml = new XMLSerializer().serializeToString(svg);
                    const svg64 = btoa(unescape(encodeURIComponent(xml)));
                    const imgSrc = 'data:image/svg+xml;base64,' + svg64;

                    // 2. è¼‰å…¥åˆ° Image å°è±¡
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = imgSrc;
                    });

                    // 3. ç¹ªè£½åˆ° Canvas (æ”¾å¤§ 3 å€ä»¥ä¿æŒé«˜æ¸…)
                    const scale = 3;
                    const canvas = document.createElement('canvas');
                    canvas.width = rect.width * scale;
                    canvas.height = rect.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(scale, scale);
                    ctx.drawImage(img, 0, 0);

                    // 4. è½‰ç‚º PNG DataURL
                    const pngUrl = canvas.toDataURL('image/png');

                    // 5. å‰µå»ºæ›¿æ›ç”¨çš„ IMG æ¨™ç±¤
                    const finalImg = document.createElement('img');
                    finalImg.src = pngUrl;
                    finalImg.style.width = `${rect.width}px`; // ç¶­æŒåŸå§‹è¦–è¦ºå°ºå¯¸
                    finalImg.style.height = `${rect.height}px`;
                    
                    // å€åˆ†è¡Œå…§æˆ–å€å¡Š
                    const container = svg.closest('mjx-container');
                    const isBlock = container.getAttribute('display') === 'true';
                    finalImg.className = isBlock ? 'math-img-block' : 'math-img-inline';

                    // 6. æ›¿æ› DOM
                    container.parentNode.replaceChild(finalImg, container);

                } catch (e) {
                    console.error("å…¬å¼è½‰æ›å¤±æ•—:", e);
                }
            }
        }

        // --- 3. ç”Ÿæˆ PDF ä¸»æµç¨‹ ---
        async function generatePDF() {
            loading.style.display = 'flex';
            const btn = document.getElementById('btn-download');
            btn.disabled = true;

            try {
                // æ­¥é©Ÿ 1: å‚™ä»½ç•¶å‰ HTML (å› ç‚ºè½‰åœ–ç‰‡æœƒç ´å£åŸæœ¬çš„å¯ç·¨è¼¯æ€§)
                const originalHTML = paper.innerHTML;

                // æ­¥é©Ÿ 2: å°‡æ‰€æœ‰ MathJax SVG è½‰ç‚º PNG
                await rasterizeMathJax();

                // æ­¥é©Ÿ 3: è¨­å®š html2pdf åƒæ•¸
                const opt = {
                    margin: 0, // é‚Šè·è¨­ç‚º 0ï¼Œç”± CSS padding æ§åˆ¶
                    filename: 'document_v8.pdf',
                    image: { type: 'jpeg', quality: 0.98 }, // ä½¿ç”¨é«˜ç•«è³ª JPEG
                    html2canvas: { 
                        scale: 2, // æé«˜æ•´é«”è§£æåº¦
                        useCORS: true, 
                        scrollY: 0,
                        windowWidth: 1000 // å¼·åˆ¶å¯¬åº¦ï¼Œé˜²æ­¢æ‰‹æ©Ÿç‰ˆå‹è·‘æ‰
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // å•Ÿç”¨æ‰€æœ‰åˆ†é ä¿è­·
                };

                // æ­¥é©Ÿ 4: ç”Ÿæˆä¸¦ä¸‹è¼‰
                loadingText.innerText = "æ­£åœ¨ç”Ÿæˆ PDF æ–‡ä»¶...";
                await html2pdf().set(opt).from(paper).save();

                // æ­¥é©Ÿ 5: é‚„åŸé è¦½å€ (è®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒç·¨è¼¯)
                paper.innerHTML = originalHTML;
                // é‡æ–°ç¶å®š MathJax äº‹ä»¶ (å› ç‚º DOM è¢«é‡ç½®äº†)
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([paper]);
                }

            } catch (err) {
                alert("ç”Ÿæˆå¤±æ•—: " + err.message);
                console.error(err);
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
