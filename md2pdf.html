<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF (LaTeX é˜²åˆ‡æ–·ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global' 
            },
            startup: {
                typeset: false // æˆ‘å€‘æ‰‹å‹•å‘¼å«æ¸²æŸ“
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; background: #525659; }
        
        header { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .container { display: flex; flex: 1; overflow: hidden; }
        .pane { width: 50%; display: flex; flex-direction: column; }
        
        /* ç·¨è¼¯å€ */
        textarea { 
            flex: 1; padding: 20px; border: none; resize: none; outline: none; 
            font-family: 'Consolas', monospace; font-size: 15px; line-height: 1.6;
        }

        /* é è¦½å€ (PDF æ¨¡æ“¬) */
        #preview-pane { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        
        #content {
            background: white;
            width: 210mm; /* A4 */
            min-height: 297mm;
            padding: 20mm;
            box-sizing: border-box; 
            color: #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* --- ğŸ”¥ æ ¸å¿ƒé˜²åˆ‡æ–· CSS ğŸ”¥ --- */
        
        /* 1. ä¸€èˆ¬å…ƒç´ é˜²åˆ‡æ–· */
        p, h1, h2, h3, li, blockquote, pre, table, img {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* 2. é‡é»ï¼šæ•¸å­¸å…¬å¼ä¿è­·æ®¼ */
        /* é€™æœƒç¢ºä¿æ•´å€‹å€å¡Šå…¬å¼è¦éº¼åœ¨é€™ä¸€é é¡¯ç¤ºå®Œï¼Œè¦éº¼æ•´å€‹è·³åˆ°ä¸‹ä¸€é  */
        .math-protect {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            display: block;
            margin: 1em 0; /* çµ¦å…¬å¼ä¸€é»å‘¼å¸ç©ºé–“ */
        }

        /* æ¨£å¼ç¾åŒ– */
        h1, h2 { border-bottom: 1px solid #eee; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #ccc; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #f0f0f0; }
        pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; }
        code { background: #eee; padding: 2px 5px; border-radius: 3px; font-family: monospace; }

        button { padding: 8px 15px; cursor: pointer; background: #4CAF50; color: white; border: none; font-size: 1rem; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: bold;">MD2PDF (LaTeX å¼·åŠ›ä¿®å¾©ç‰ˆ)</div>
        <button onclick="downloadPDF()">ä¸‹è¼‰ PDF</button>
    </header>

    <div class="container">
        <div class="pane">
            <textarea id="editor" placeholder="è¼¸å…¥ Markdown..."># LaTeX é˜²åˆ‡æ–·æ¸¬è©¦

é€™æ˜¯ä¸€å€‹æ¸¬è©¦ã€‚è«‹ç¢ºä¿ä¸‹æ–¹çš„é•·å…¬å¼ä¸æœƒè¢«åˆ‡æˆå…©åŠã€‚

## é¦¬å…‹å£«å¨æ–¹ç¨‹çµ„

$$
\begin{aligned}
\nabla \cdot \mathbf{E} &= \frac{\rho}{\varepsilon_0} \\
\nabla \cdot \mathbf{B} &= 0 \\
\nabla \times \mathbf{E} &= -\frac{\partial \mathbf{B}}{\partial t} \\
\nabla \times \mathbf{B} &= \mu_0\mathbf{J} + \mu_0\varepsilon_0\frac{\partial \mathbf{E}}{\partial t}
\end{aligned}
$$

## çŸ©é™£æ¸¬è©¦ (ç¢ºä¿æ•´å¡Šç§»å‹•)

é€™æ˜¯ä¸€æ®µå»¢è©±æ–‡å­—ï¼Œç”¨ä¾†æŠŠé é¢å¡«æ»¿ï¼Œå¥½è®“ä¸‹ä¸€å€‹å…¬å¼å‰›å¥½å¡åœ¨åˆ†é è™•ã€‚é€™æ˜¯ä¸€æ®µå»¢è©±æ–‡å­—ã€‚é€™æ˜¯ä¸€æ®µå»¢è©±æ–‡å­—ã€‚

$$
\mathbf{A} = \begin{pmatrix}
a_{11} & a_{12} & \cdots & a_{1n} \\
a_{21} & a_{22} & \cdots & a_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
a_{m1} & a_{m2} & \cdots & a_{mn}
\end{pmatrix}
$$

## è¡Œå…§å…¬å¼
é€™æ˜¯ä¸€å€‹è¡Œå…§å…¬å¼ $E=mc^2$ çš„æ¸¬è©¦ï¼Œå®ƒæ‡‰è©²éš¨æ–‡æµå‹•ã€‚
            </textarea>
        </div>
        <div class="pane" id="preview-pane">
            <div id="content"></div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const content = document.getElementById('content');
        let mathCache = {};

        // 1. æŠ“å‡º LaTeX ä¸¦æš«å­˜ (é¿å…è¢« marked è§£æå£)
        function escapeMath(text) {
            mathCache = {}; 
            let i = 0;
            // æŠ“å€å¡Šå…¬å¼ $$...$$
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => { 
                const key = `MATH_BLOCK_${i++}`;
                mathCache[key] = { tex: t, isBlock: true };
                return key; 
            });
            // æŠ“è¡Œå…§å…¬å¼ $...$
            text = text.replace(/\$([^\$\n]+?)\$/g, (m, t) => { 
                const key = `MATH_INLINE_${i++}`;
                mathCache[key] = { tex: t, isBlock: false };
                return key; 
            });
            return text;
        }

        // 2. é‚„åŸ LaTeX ä¸¦åŠ ä¸Šã€Œä¿è­·æ®¼ã€
        function restoreMath(html) {
            for (const key in mathCache) {
                const item = mathCache[key];
                if (item.isBlock) {
                    // ğŸ”¥ é—œéµä¿®æ”¹ï¼šç”¨ div.math-protect åŒ…ä½å€å¡Šå…¬å¼ ğŸ”¥
                    // é€™æ¨£ CSS çš„ break-inside: avoid æ‰èƒ½æŠ“åˆ°å®ƒ
                    html = html.replace(key, `<div class="math-protect">$$${item.tex}$$</div>`);
                } else {
                    html = html.replace(key, `$${item.tex}$`);
                }
            }
            return html;
        }

        // 3. æ¸²æŸ“æµç¨‹
        function render() {
            let md = editor.value;
            // A. ä¿è­·å…¬å¼
            md = escapeMath(md);
            // B. è½‰ HTML
            let html = marked.parse(md);
            // C. é‚„åŸå…¬å¼ (å«ä¿è­·æ®¼)
            html = restoreMath(html);
            // D. æ”¾å…¥ DOM
            content.innerHTML = html;
            
            // E. å‘¼å« MathJax æ¸²æŸ“
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([content]).catch(err => console.log(err));
            }
        }

        // ç›£è½è¼¸å…¥ (åŠ ä¸€é»å»¶é²é¿å…é »ç¹æ¸²æŸ“å¡é “)
        let timer;
        editor.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(render, 300);
        });
        
        // åˆå§‹åŒ–
        setTimeout(render, 500);

        // 4. ä¸‹è¼‰ PDF
        function downloadPDF() {
            const element = document.getElementById('content');
            
            const opt = {
                margin:       0, // é€™è£¡è¨­0ï¼Œä¾é  CSS padding
                filename:     'latex-fixed.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true,
                    scrollY: 0 // é˜²æ­¢æ»¾å‹•å°è‡´æˆªåœ–ä½ç½®åç§»
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
