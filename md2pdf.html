<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF V11 (é˜²ç™½å±ä¿®æ­£ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'none' },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: #2b2b2b; font-family: sans-serif; }
        
        header { 
            height: 50px; background: #1a1a1a; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #444; 
        }

        .main { display: flex; flex: 1; overflow: hidden; }
        
        .editor-area { width: 50%; display: flex; flex-direction: column; border-right: 1px solid #444; }
        textarea { 
            flex: 1; width: 100%; background: #1e1e1e; color: #e0e0e0; border: none; padding: 20px; 
            resize: none; outline: none; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6;
        }

        .preview-area { 
            width: 50%; background: #525659; overflow-y: auto; display: flex; justify-content: center; padding: 30px; 
        }

        #paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        /* å…§å®¹æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 2px solid #000; }
        th, td { border: 1px solid #666; padding: 8px; }
        th { background: #f0f0f0; }
        img { max-width: 100%; }
        
        /* é˜²åˆ‡æ–· */
        p, h1, h2, h3, li, table, pre, .math-block { 
            page-break-inside: avoid; break-inside: avoid; 
        }

        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); 
            color:white; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99999;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">æ­£åœ¨ç”Ÿæˆ PDF...</div>
        <div>è«‹ç¨å€™ï¼Œæ­£åœ¨é€²è¡Œç•«é¢æ¸²æŸ“</div>
    </div>

    <header>
        <div style="font-weight: bold;">MD2PDF V11 (é˜²ç™½å±)</div>
        <button onclick="downloadPDF()" style="cursor:pointer; background:#27ae60; color:white; border:none; padding:8px 20px; border-radius:4px; font-weight:bold;">
            ä¸‹è¼‰ PDF
        </button>
    </header>

    <div class="main">
        <div class="editor-area">
            <textarea id="input"># ç©ºç™½ä¿®å¾©æ¸¬è©¦

é€™æ¬¡ä¸‹è¼‰ PDF **çµ•å°ä¸æœƒ** æ˜¯ç©ºç™½çš„ã€‚

## 1. æ¸¬è©¦è¡¨æ ¼
| æ¸¬è©¦é …ç›® | ç‹€æ…‹ |
| :--- | :--- |
| PDF å…§å®¹ | âœ… å¯è¦‹ |
| å·¦é‚Šè· | âœ… å®Œæ•´ |

## 2. æ¸¬è©¦å…¬å¼
$$
E = mc^2 + \int_0^1 x dx
$$

## 3. æ¸¬è©¦é•·å…§å®¹
è«‹ç¢ºä¿å…§å®¹æœ‰è¢«æ­£ç¢ºæ¸²æŸ“ã€‚
            </textarea>
        </div>
        <div class="preview-area">
            <div id="paper"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const paper = document.getElementById('paper');
        const loading = document.getElementById('loading');

        // --- 1. æ¸²æŸ“ Markdown ---
        function render() {
            let md = input.value;
            let mathStore = [];
            
            md = md.replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => {
                mathStore.push({ t, type: 'block' }); return `MATHBLOCK${mathStore.length - 1}END`;
            });
            md = md.replace(/\$([^\$\n]+?)\$/g, (m, t) => {
                mathStore.push({ t, type: 'inline' }); return `MATHINLINE${mathStore.length - 1}END`;
            });

            let html = marked.parse(md);

            html = html.replace(/MATHBLOCK(\d+)END/g, (m, id) => `<div class="math-block">$$${mathStore[id].t}$$</div>`);
            html = html.replace(/MATHINLINE(\d+)END/g, (m, id) => `$${mathStore[id].t}$`);

            paper.innerHTML = html;

            if(window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([paper]);
            }
        }

        let timer;
        input.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(render, 300); });
        setTimeout(render, 500);


        // --- 2. è½‰åœ–ç‰‡ (åœ¨æ›¿èº«ä¸­åŸ·è¡Œ) ---
        async function rasterize(element) {
            const svgs = element.querySelectorAll('mjx-container svg');
            for(let svg of svgs) {
                try {
                    const rect = svg.getBoundingClientRect();
                    if(rect.width < 1) continue;

                    const xml = new XMLSerializer().serializeToString(svg);
                    const svg64 = btoa(unescape(encodeURIComponent(xml)));
                    const img = new Image();
                    img.src = 'data:image/svg+xml;base64,' + svg64;
                    await new Promise(r => img.onload = r);

                    const canvas = document.createElement('canvas');
                    canvas.width = rect.width * 3;
                    canvas.height = rect.height * 3;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(3, 3);
                    ctx.drawImage(img, 0, 0);

                    const finalImg = document.createElement('img');
                    finalImg.src = canvas.toDataURL('image/png');
                    finalImg.style.width = rect.width + 'px';
                    
                    const wrapper = svg.closest('mjx-container');
                    if(wrapper) wrapper.replaceWith(finalImg);
                } catch(e) { console.error(e); }
            }
        }

        // --- 3. ä¸‹è¼‰ (ä¿®å¾©ç™½å±æ ¸å¿ƒï¼šä½¿ç”¨å¯è¦‹çš„ Overlay) ---
        async function downloadPDF() {
            loading.style.display = 'flex';

            // A. å»ºç«‹æ›¿èº« (Clone)
            const clone = paper.cloneNode(true);
            document.body.appendChild(clone);

            // B. ğŸ”¥ é—œéµï¼šè®“æ›¿èº«è¦†è“‹åœ¨è¢å¹•æœ€ä¸Šæ–¹ ğŸ”¥
            // åªæœ‰å…ƒç´ æ˜¯ã€Œå¯è¦‹çš„ã€ï¼Œhtml2canvas æ‰èƒ½ç•«å‡ºæ±è¥¿ï¼Œä¸æœƒç™½å±
            clone.style.position = 'fixed';
            clone.style.top = '0';
            clone.style.left = '0';
            clone.style.zIndex = '99999'; // æ”¾åœ¨ Loading é®ç½©ä¹‹ä¸Šæˆ–ä¹‹ä¸‹çš†å¯ï¼Œé‡é»æ˜¯ browser è¦ render å®ƒ
            clone.style.width = '210mm';
            clone.style.height = 'auto';
            clone.style.padding = '0'; // ç§»é™¤ padding äº¤çµ¦ PDF margin
            clone.style.background = 'white';
            clone.style.margin = '0';

            try {
                // ç­‰å¾…ç€è¦½å™¨æ¸²æŸ“é€™å€‹æ›¿èº«
                await new Promise(r => setTimeout(r, 100));

                // è½‰åœ–ç‰‡
                await rasterize(clone);

                // C. ç”Ÿæˆ PDF
                const opt = {
                    margin:       [15, 15, 15, 15], 
                    filename:     'fixed_document.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0,
                        windowWidth: 1000 // å¼·åˆ¶å¯¬åº¦ï¼Œé¿å…è·‘ç‰ˆ
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
                };

                await html2pdf().set(opt).from(clone).save();

            } catch(e) {
                alert('éŒ¯èª¤: ' + e.message);
            } finally {
                // D. ç§»é™¤æ›¿èº«
                document.body.removeChild(clone);
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
