<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD2PDF Final Solution</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'none' },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        /* Reset */
        * { box-sizing: border-box; }
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; background: #222; font-family: sans-serif; overflow: hidden; }
        
        /* ä»‹é¢ä½ˆå±€ */
        header { 
            height: 60px; background: #111; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #333; z-index: 10;
        }

        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* ç·¨è¼¯å™¨ */
        .editor-box { width: 50%; height: 100%; border-right: 1px solid #333; display: flex; flex-direction: column; }
        textarea { 
            flex: 1; width: 100%; background: #1e1e1e; color: #ccc; border: none; padding: 20px; 
            resize: none; outline: none; font-family: 'Consolas', monospace; font-size: 15px; line-height: 1.6;
        }

        /* é è¦½å€å®¹å™¨ (æœ‰æ²è»¸) */
        .preview-box { 
            width: 50%; height: 100%; background: #525659; overflow-y: auto; 
            display: flex; justify-content: center; padding: 40px 20px;
            position: relative;
        }

        /* A4 ç´™å¼µ (ä¸»è§’) */
        #paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            /* è®“å…§å®¹æ’é–‹ */
            height: auto; 
        }

        /* å…§å®¹æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 2px solid #000; }
        th, td { border: 1px solid #666; padding: 8px 12px; }
        th { background: #f0f0f0; }
        img { max-width: 100%; }
        h1, h2 { border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* é˜²åˆ‡æ–·è¨­å®š */
        p, h1, h2, h3, li, table, pre, .math-block { 
            page-break-inside: avoid; break-inside: avoid; 
        }

        /* Loading é®ç½© */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 99999;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px;">æ­£åœ¨ç”Ÿæˆ PDF...</div>
        <div>è™•ç†æ•¸å­¸å…¬å¼èˆ‡æ’ç‰ˆä¸­ï¼Œè«‹å‹¿é—œé–‰</div>
    </div>

    <header>
        <div style="font-weight: bold; font-size: 18px;">MD2PDF V12 (ç§»èŠ±æ¥æœ¨ç‰ˆ)</div>
        <button onclick="startDownload()" style="cursor:pointer; background:#2980b9; color:white; border:none; padding:10px 25px; border-radius:4px; font-weight:bold; font-size: 14px;">
            ä¸‹è¼‰ PDF
        </button>
    </header>

    <div class="workspace">
        <div class="editor-box">
            <textarea id="input"># æœ€çµ‚æ¸¬è©¦

å¦‚æœä¸æˆåŠŸï¼Œæˆ‘å°±æŠŠéµç›¤åƒæ‰ã€‚

## 1. åº§æ¨™èˆ‡åˆ‡é‚Šæ¸¬è©¦
è«‹æª¢æŸ¥å·¦é‚Šæ˜¯å¦æœ‰ç•™ç™½ï¼Œå…§å®¹æ˜¯å¦å®Œæ•´ã€‚
å› ç‚ºæˆ‘å€‘ä½¿ç”¨äº†ã€Œç§»èŠ±æ¥æœ¨æ³•ã€ï¼Œé€™å¼µç´™åœ¨ç”Ÿæˆçš„ç¬é–“æ˜¯è¢«ç§»åˆ° (0,0) çš„ï¼Œç†è«–ä¸Šä¸å¯èƒ½è¢«åˆ‡é‚Šã€‚

## 2. è¡¨æ ¼æ¸¬è©¦
| æ¸¬è©¦é …ç›® | çµæœ |
| :--- | :--- |
| ç©ºç™½é  | âŒ Fixed |
| åˆ‡é‚Š | âŒ Fixed |
| æ•¸å­¸å…¬å¼ | âœ… Rendered |

## 3. æ•¸å­¸å…¬å¼
$$
\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
$$

## 4. é•·å…§å®¹æ¸¬è©¦
é€™æ˜¯ä¸€æ®µå¾ˆé•·å¾ˆé•·çš„å…§å®¹ï¼Œç”¨ä¾†æ¸¬è©¦åˆ†é æ•ˆæœã€‚
Lorem ipsum dolor sit amet, consectetur adipiscing elit.
            </textarea>
        </div>
        <div class="preview-box" id="preview-container">
            <div id="paper"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const paper = document.getElementById('paper');
        const previewContainer = document.getElementById('preview-container');
        const overlay = document.getElementById('loading-overlay');

        // --- 1. æ¸²æŸ“å¼•æ“ ---
        function render() {
            let md = input.value;
            let mathStore = [];
            
            // å®‰å…¨ä½”ä½ç¬¦
            md = md.replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => {
                mathStore.push({t, type:'block'}); return `MATHBLOCK${mathStore.length-1}END`;
            });
            md = md.replace(/\$([^\$\n]+?)\$/g, (m, t) => {
                mathStore.push({t, type:'inline'}); return `MATHINLINE${mathStore.length-1}END`;
            });

            let html = marked.parse(md);

            html = html.replace(/MATHBLOCK(\d+)END/g, (m, id) => `<div class="math-block">$$${mathStore[id].t}$$</div>`);
            html = html.replace(/MATHINLINE(\d+)END/g, (m, id) => `$${mathStore[id].t}$`);

            paper.innerHTML = html;

            if(window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([paper]);
            }
        }

        // é˜²æŠ–å‹•è¼¸å…¥ç›£è½
        let timer;
        input.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(render, 300); });
        setTimeout(render, 500);


        // --- 2. è½‰åœ–ç‰‡ (ä¿è­‰ MathJax ä¸è·‘ç‰ˆ) ---
        async function rasterizeMath() {
            const svgs = paper.querySelectorAll('mjx-container svg');
            for(let svg of svgs) {
                try {
                    const rect = svg.getBoundingClientRect();
                    if(rect.width < 1) continue;

                    const xml = new XMLSerializer().serializeToString(svg);
                    const svg64 = btoa(unescape(encodeURIComponent(xml)));
                    const img = new Image();
                    img.src = 'data:image/svg+xml;base64,' + svg64;
                    await new Promise(r => img.onload = r);

                    const canvas = document.createElement('canvas');
                    canvas.width = rect.width * 3;
                    canvas.height = rect.height * 3;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(3, 3);
                    ctx.drawImage(img, 0, 0);

                    const finalImg = document.createElement('img');
                    finalImg.src = canvas.toDataURL('image/png');
                    finalImg.style.width = rect.width + 'px';
                    
                    const wrapper = svg.closest('mjx-container');
                    if(wrapper) wrapper.replaceWith(finalImg);
                } catch(e) { console.error(e); }
            }
        }

        // --- 3. ä¸‹è¼‰ PDF (æ ¸å¿ƒï¼šç§»èŠ±æ¥æœ¨å¤§æ³•) ---
        async function startDownload() {
            overlay.style.display = 'flex';
            
            // A. ä¿å­˜åŸå§‹ HTML (å› ç‚ºè½‰åœ–æœƒç ´å£å¯ç·¨è¼¯æ€§)
            const backupHTML = paper.innerHTML;

            // B. è½‰åœ–ç‰‡
            await rasterizeMath();

            // C. ğŸ”¥ ç§»èŠ±æ¥æœ¨ï¼šæŠŠ #paper æ‹”å‡ºä¾†ï¼Œè²¼åˆ° body æœ€é ‚å±¤ ğŸ”¥
            // é€™ä¸€æ­¥æ¶ˆé™¤äº†æ‰€æœ‰çˆ¶å®¹å™¨çš„æ²è»¸åç§»ã€overflowéš±è—ç­‰å•é¡Œ
            const originalParent = paper.parentNode;
            const originalNextSibling = paper.nextSibling; // è¨˜ä½ä½ç½®ä»¥ä¾¿æ”¾å›å»
            
            document.body.appendChild(paper);
            
            // å¼·åˆ¶è¨­å®šæ¨£å¼ï¼Œç¢ºä¿ html2canvas çœ‹åˆ°çš„åªæœ‰é€™å¼µç´™ï¼Œä¸”ä½ç½®çµ•å°æ­£ç¢º
            paper.style.position = 'absolute';
            paper.style.left = '0';
            paper.style.top = '0';
            paper.style.zIndex = '9999';
            paper.style.margin = '0';
            // æš«æ™‚ç§»é™¤ paddingï¼Œç”± PDF margin æ¥ç®¡ (é˜²æ­¢åˆ‡é‚Š)
            const originalPadding = paper.style.padding;
            paper.style.padding = '0';

            try {
                const opt = {
                    margin:       [20, 20, 20, 20], // åœ¨ PDF è£¡åŠ å› 20mm é‚Šè·
                    filename:     'md2pdf_final.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: 1000 // é–å®šå¯¬åº¦é˜²æ­¢è®Šå½¢
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // å°é€™å€‹å·²ç¶“ç§»åˆ°é ‚å±¤çš„ paper é€²è¡Œæˆªåœ–
                await html2pdf().set(opt).from(paper).save();

            } catch (e) {
                alert('ç”ŸæˆéŒ¯èª¤: ' + e.message);
            } finally {
                // D. æ­¸ä½ï¼šæŠŠç´™æ”¾å›å»
                if (originalNextSibling) {
                    originalParent.insertBefore(paper, originalNextSibling);
                } else {
                    originalParent.appendChild(paper);
                }
                
                // é‚„åŸæ¨£å¼
                paper.style.position = '';
                paper.style.left = '';
                paper.style.top = '';
                paper.style.zIndex = '';
                paper.style.margin = '';
                paper.style.padding = '20mm'; // åŠ å›è¢å¹•é è¦½ç”¨çš„ padding
                
                // é‚„åŸ HTML (æ¢å¾© SVG å…¬å¼)
                paper.innerHTML = backupHTML;
                if(window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([paper]);
                }
                
                overlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>
